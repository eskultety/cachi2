name: Check whether pip-compile changes are needed
run-name: dependabot_pipcompile

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
    paths:
      - requirements.txt
      - requirements-extras.txt
  workflow_dispatch:
    inputs: {}

permissions: write-all

jobs:
  pip-compile-check:
    runs-on: ubuntu-24.04
    container:
      image: python:3.9-alpine

    steps:
      - name: Install dependencies
        run: apk update && apk add --no-cache git

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pip-tools
        run: |
          pip install --upgrade pip
          pip install --no-cache-dir pip-tools

      # Step 4: Run pip-compile to update requirements.txt based on pyproject.toml
      - name: Run pip-compile to update requirements.txt
        id: gitdiff
        run: |
          git config --global --add safe.directory "*"
          pip-compile --generate-hashes --output-file=requirements.txt pyproject.toml
          pip-compile \
              --all-extras \
              --allow-unsafe \
              --generate-hashes \
              --output-file=requirements-extras.txt \
              pyproject.toml
          {
            echo 'GIT_DIFF<<EOF'
            git diff -p
            echo EOF
          } >> "$GITHUB_ENV"

      - name: Comment on pull request
        uses: actions/github-script@v7
        if: env.GIT_DIFF != ''
        env:
          DIFF: "Manual changes are needed. Please apply the following patch and update the pull request:\n```diff\n${{ env.GIT_DIFF }}\n```"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.pull_request.number }},
              owner: context.payload.repository.owner.login,
              repo: context.payload.repository.name,
              body: process.env.DIFF
            })
